name: Cleanup PR Branch and Issues

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate skip flags
        id: flags
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => (l.name || '').toLowerCase());
            const keepBranch = labels.includes('keep-branch');
            const keepIssue = labels.includes('keep-issue-open');
            core.setOutput('keep_branch', keepBranch ? 'true' : 'false');
            core.setOutput('keep_issue', keepIssue ? 'true' : 'false');
            core.notice(`keep-branch: ${keepBranch}, keep-issue-open: ${keepIssue}`);

      - name: Delete branch for same-repo PRs
        if: steps.flags.outputs.keep_branch != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const headRef = pr.head.ref;
            const headRepo = pr.head.repo.full_name;
            const baseRepo = pr.base.repo.full_name;
            const defaultBranch = pr.base.repo.default_branch;

            if (headRepo !== baseRepo) {
              core.notice(`Skip delete: branch in fork (${headRepo})`);
              return;
            }

            if (headRef === defaultBranch) {
              core.notice(`Skip delete: default branch ${defaultBranch}`);
              return;
            }

            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${headRef}`
              });
              core.notice(`Deleted branch ${headRef}`);
            } catch (error) {
              if (error.status === 422 || error.status === 404) {
                core.warning(`Branch already removed: ${headRef}`);
              } else {
                throw error;
              }
            }

      - name: Close linked issue
        if: steps.flags.outputs.keep_issue != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const candidates = new Set();

            // Prefer issue numbers embedded in our auto-generated branch names
            const branchPatterns = [
              /content-edit-issue-(\d+)$/i,
              /upload-images-issue-(\d+)$/i,
              /yml-edit-issue-(\d+)$/i,
              /issue-(\d+)$/i
            ];

            for (const pattern of branchPatterns) {
              const match = pr.head.ref.match(pattern);
              if (match && match[1]) {
                candidates.add(parseInt(match[1], 10));
              }
            }

            // Fallback: parse PR body for #123 references
            const body = pr.body || '';
            for (const match of body.matchAll(/#(\d+)/g)) {
              if (match[1]) {
                candidates.add(parseInt(match[1], 10));
              }
            }

            if (candidates.size === 0) {
              core.notice('No issue number detected; nothing to close.');
              return;
            }

            for (const issue_number of candidates) {
              try {
                const issue = await github.rest.issues.get({
                  ...context.repo,
                  issue_number
                });

                if (issue.data.state === 'closed') {
                  core.notice(`Issue #${issue_number} already closed`);
                  continue;
                }

                await github.rest.issues.update({
                  ...context.repo,
                  issue_number,
                  state: 'closed'
                });

                core.notice(`Closed issue #${issue_number}`);
              } catch (error) {
                if (error.status === 404) {
                  core.warning(`Issue #${issue_number} not found`);
                } else {
                  throw error;
                }
              }
            }

