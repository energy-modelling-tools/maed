name: Save issue attachments to repository

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  upload:
    # Only trigger if issue has the label "upload-image"
    if: contains(github.event.issue.labels.*.name, 'upload-image')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract path and image links from issue body
        id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.issue.body || '';

            // Parse Target Path from GitHub Forms format: ### Target Path\n\nvalue
            let targetPath = 'assets/img/EMP/';
            const pathPatterns = [
              /###\s*Target Path\s*\n\s*([^\n]+)/i,
              /###\s*Target Path\s*\n\n\s*([^\n]+)/i,
              /^\s*path:\s*([^\s]+)\s*$/mi  // Fallback for old format
            ];
            
            for (const pattern of pathPatterns) {
              const match = body.match(pattern);
              if (match && match[1]) {
                targetPath = match[1].trim();
                break;
              }
            }
            
            // Ensure path ends with /
            if (!targetPath.endsWith('/')) {
              targetPath += '/';
            }
            
            core.info(`Target path: ${targetPath}`);
            core.setOutput('targetPath', targetPath);

            // Parse Markdown image links: ![alt](url)
            const regex = /!\[([^\]]*)]\((https?:\/\/[^\s)]+)\)/g;
            const items = [];
            let m;
            while ((m = regex.exec(body)) !== null) {
              items.push({ alt: (m[1] || '').trim(), url: m[2] });
            }
            core.info(`Found ${items.length} attachments`);
            core.setOutput('items', JSON.stringify(items));

      - name: Download attachments using generated filenames
        if: steps.extract.outputs.items != '[]'
        run: |
          python - << 'PY'
          import json, os, pathlib, re, urllib.request, urllib.parse

          items = json.loads(os.environ["ITEMS"])
          issue_number = os.environ["ISSUE_NUMBER"]
          outdir = pathlib.Path(os.environ["TARGET_PATH"])
          outdir.mkdir(parents=True, exist_ok=True)

          EXT_MAP = {
              "image/png": "png",
              "image/jpeg": "jpg",
              "image/jpg": "jpg",
              "image/gif": "gif",
              "image/webp": "webp",
              "image/svg+xml": "svg",
          }

          def safe_name(s: str) -> str:
              s = s.strip()
              if not s:
                  return ""
              s = re.sub(r'[^A-Za-z0-9._-]+', "_", s)
              return s or ""

          saved = []

          for idx, item in enumerate(items, start=1):
              url = item["url"]
              alt = item.get("alt") or ""
              base = safe_name(alt) or f"file{idx}"

              # Fetch file
              try:
                  req = urllib.request.Request(url, method="GET")
                  with urllib.request.urlopen(req) as resp:
                      ct = resp.info().get_content_type()
                      data = resp.read()
              except Exception as e:
                  print(f"Failed to fetch {url}: {e}")
                  continue

              # Determine extension
              ext = EXT_MAP.get(ct, "")
              if not ext:
                  # Try guessing extension from URL
                  path = urllib.parse.urlparse(url).path
                  filename = os.path.basename(path)
                  m = re.search(r'\.([A-Za-z0-9]+)$', filename)
                  if m:
                      ext = m.group(1).lower()
                  else:
                      ext = "bin"

              filename = f"{base}.{ext}"
              target = outdir / filename

              # Avoid collisions
              orig = target
              k = 1
              while target.exists():
                  target = orig.with_name(f"{orig.stem}_{k}{orig.suffix}")
                  k += 1

              print(f"Saving {url} -> {target}")
              try:
                  with open(target, "wb") as f:
                      f.write(data)
                  saved.append(str(target))
              except Exception as e:
                  print(f"Failed to save file {target}: {e}")

          with open("uploaded_files.txt", "w") as f:
              for p in saved:
                  f.write(p + "\n")
          PY
        env:
          ITEMS: ${{ steps.extract.outputs.items }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          TARGET_PATH: ${{ steps.extract.outputs.targetPath }}

      - name: Create Pull Request
        if: steps.extract.outputs.items != '[]'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Upload images from issue #${{ github.event.issue.number }}"
          title: "Upload images from issue #${{ github.event.issue.number }}"
          body: |
            This PR was automatically created from issue #${{ github.event.issue.number }}.
            
            **Uploaded files:**
            Target path: `${{ steps.extract.outputs.targetPath }}`
            
            Please review and merge if everything looks good.
            
            ---
            Related to #${{ github.event.issue.number }}
          branch: "upload-images-issue-${{ github.event.issue.number }}"
          delete-branch: true
          labels: upload-image

      - name: Comment on issue
        if: success() && steps.extract.outputs.items != '[]'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let msg = '';
            if (fs.existsSync('uploaded_files.txt')) {
              const lines = fs.readFileSync('uploaded_files.txt', 'utf8')
                .split('\n')
                .filter(Boolean);
              if (lines.length > 0) {
                msg = '✅ A Pull Request has been created with your uploaded images.\n\nUploaded files:\n' + lines.map(p => '- `' + p + '`').join('\n');
                msg += '\n\nPlease review the PR and merge it when ready.';
              } else {
                msg = '⚠️ No files were saved. Please check if the image URLs are valid.';
              }
            } else {
              msg = '⚠️ No files were downloaded. Please make sure you uploaded images in Markdown format: `![alt](url)`';
            }

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: msg
            });

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: '❌ Failed to process attachments. Please check the workflow logs for details.'
            });
